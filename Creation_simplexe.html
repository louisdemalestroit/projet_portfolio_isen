<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modification des Cat√©gories</title>
    <link rel="stylesheet" href="styless.css">
</head>
<body>    
    <header>
        <nav class="menu_fichier">
            <div class="left-group_fichier">
                <a href="Carte_Personnel.html" class="nav-link button_fichier">Liste El√®ves</a>
                <a href="Creation_simplexe.html" class="nav-link button_fichier">Modification simplexe</a>
            </div>
            <div class="right-group1">
                <span id="identifiant-affiche"></span> 
                <a href="connexion.html" class="button_fichier">D√©connexion</a>
            </div>
        </nav>
    </header>

    <h1>Modifier les Cat√©gories</h1>
    <div id="category-edit-container">
        <label for="page-select">S√©lectionner une page :</label>
        <select id="page-select">
            <option value="resolution.html">Resolution</option>
            <option value="organisation.html">Organisation</option>
            <option value="communication.html">Communication</option>
            <option value="recul.html">Recul</option>
            <option value="reflexion.html">Reflexion</option>
        </select>
        <br><br>

        <div id="categories-inputs">
            <!-- Champs g√©n√©r√©s dynamiquement -->
        </div>
        <br>
        <button id="add-button">+ Ajouter une cat√©gorie</button>
        <br><br>
        <button id="save-button">Valider</button>

        <button id="delete-button">Supprimer les donn√©es</button>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const pageSelect = document.getElementById("page-select");
            const saveButton = document.getElementById("save-button");
            const addButton = document.getElementById("add-button");
            const deleteButton = document.getElementById("delete-button");
            const inputsContainer = document.getElementById("categories-inputs");
    
            function loadCategories() {
                const selectedPage = pageSelect.value;
                const storedCategories = JSON.parse(localStorage.getItem(selectedPage)) || [];
    
                // Supprimer tous les champs actuels
                inputsContainer.innerHTML = '';
    
                storedCategories.forEach((value, i) => {
                    addCategoryInput(value, i);
                });
    
                // Toujours avoir au moins 5 champs
                for (let i = storedCategories.length; i < 5; i++) {
                    addCategoryInput('', i);
                }
            }
    
            function addCategoryInput(value = "", index = null) {
                const currentCount = inputsContainer.querySelectorAll("input").length;
                if (currentCount >= 7) return;
    
                const div = document.createElement("div");
                div.className = "input-wrapper";
    
                const input = document.createElement("input");
                input.type = "text";
                input.placeholder = `Cat√©gorie ${currentCount + 1}`;
                input.value = value;
                input.id = `cat-${currentCount}`;
    
                div.appendChild(input);
    
                // Ajouter bouton "Supprimer" si au-del√† des 5 premiers
                if (currentCount >= 5) {
                    const deleteBtn = document.createElement("button");
                    deleteBtn.textContent = "Supprimer";
                    deleteBtn.type = "button";
                    deleteBtn.style.marginLeft = "8px";
                    deleteBtn.onclick = () => {
                        div.remove();
                        updateInputIds();
                    };
                    div.appendChild(deleteBtn);
                }
    
                inputsContainer.appendChild(div);
            }
    
            function updateInputIds() {
                const inputWrappers = inputsContainer.querySelectorAll(".input-wrapper");
                inputWrappers.forEach((wrapper, index) => {
                    const input = wrapper.querySelector("input");
                    input.id = `cat-${index}`;
                    input.placeholder = `Cat√©gorie ${index + 1}`;
                });
            }
    
            addButton.addEventListener("click", () => {
                const currentCount = inputsContainer.querySelectorAll("input").length;
                if (currentCount < 7) {
                    addCategoryInput();
                }
            });
    
            saveButton.addEventListener("click", () => {
                const selectedPage = pageSelect.value;
    
                // S√©lectionne uniquement les champs pr√©sents
                const inputs = inputsContainer.querySelectorAll("input");
    
                // R√©cup√®re leurs valeurs (et ignore les champs vides)
                const newCategories = Array.from(inputs)
                    .map(input => input.value)
                    .filter(value => value.trim() !== "");
    
                localStorage.setItem(selectedPage, JSON.stringify(newCategories));
                alert(`Cat√©gories mises √† jour pour ${selectedPage}`);
            });
    
            deleteButton.addEventListener("click", () => {
                const selectedPage = pageSelect.value;
                const tableName = selectedPage.replace(".html", ""); // Envoie juste "communication" etc.
    
                // üîç Affichage dans la console de ce qui est envoy√©
                console.log("Table envoy√©e dans la requ√™te :", tableName);
    
                const xhr = new XMLHttpRequest();
                xhr.open("POST", "delete_category.php", true);
                xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        if (response.success) {
                            alert("Les donn√©es ont √©t√© supprim√©es avec succ√®s.");
                            localStorage.removeItem(selectedPage);
                            loadCategories(); // Recharger les cat√©gories apr√®s suppression
                        } else {
                            alert("Erreur lors de la suppression des donn√©es.");
                        }
                    }
                };
                xhr.send("category=" + encodeURIComponent(tableName));
            });
    
            pageSelect.addEventListener("change", loadCategories);
            loadCategories(); // Chargement initial
        });
    </script>
    
</body>
</html>
